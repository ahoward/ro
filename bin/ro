#! /usr/bin/env ruby
Main do
  option('root') { ENV['RO_ROOT'] }

  def run
    help!
  end

  mode(:build) do
    def run
      index = []

      # FIXME: - this list should be sorted by default.....
      ro.nodes.each do |node|
        attributes = node.attributes

        # identifier = node.identifier
        # position = attributes.has_key?(:position) ? attributes[:position] : 0

        meta = {
          # :position => position
        }
        index.push(meta)

        json = JSON.pretty_generate(node.as_json)
        path = node.path
        index_json = File.join(path, 'index.json')
        IO.binwrite(index_json, json)
        puts index_json
      end
    end
  end

  mode(:console) do
    def run
      Ro.root = params['root'].value if params['root'].given?
      require "#{$libdir}/ro/console.rb"
      Ro::Console.start!
    end
  end

  mode(:cat) do
    argument('identifier')

    def run
      identifier = params['identifier'].value

      result = ro[identifier]

      result = if result.respond_to?(:as_json)
                 result.as_json
               else
                 { identifier => result }
               end

      puts JSON.pretty_generate(result)
    end
  end
end

BEGIN {
  require 'main'

  $bindir = File.dirname(__FILE__)
  $libdir = File.expand_path("#{$bindir}/../lib/")

  require "#{$libdir}/ro.rb"
}
