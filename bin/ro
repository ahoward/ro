#! /usr/bin/env ruby
Ro.script do
  help <<~____

    NAME
      ro

    SYNOPSIS
      # start a console
      ~> ro console

  ____

  run do
    help!
  end

  run(:console) do
    setup!

    console!
  end

  run(:build) do
    setup!

    if opts.fetch(:watch)
      watch(Ro.config.root) { build! }
    else
      build!
    end
  end

  run(:serve) do
    serve!
  end

  protected

  def console!
    require "#{$libdir}/ro/script/console.rb"

    Ro::Script::Console.run!(script: self)
  end

  def build!
    require "#{$libdir}/ro/script/builder.rb"

    Ro::Script::Builder.run!(script: self)
  end

  def serve!
    setup!

    Ro.config.set(:url, server_url)

    build!

    threads = [watcher!, server!]

    trap('INT') do
      threads.each do |thread|
        thread.kill
      rescue StandardError
        nil
      end
      exit
    end

    sleep
  end

  def server!
    require 'webrick'

    port = opts.fetch(:port)
    build_directory = Ro.config.build_directory
    document_root = build_directory.dirname

    index_url = File.join(server_url, 'index.json')

    say("ro.server: @ #{index_url}", color: :magenta)

    Thread.new do
      Thread.current.abort_on_exception = true

      server = WEBrick::HTTPServer.new(
        DocumentRoot: document_root,
        Port: port
      )

      ::Kernel.at_exit { server.shutdown }

      server.start
    end
  end

  def server_url
    port = opts.fetch(:port)
    build_directory = Ro.config.build_directory
    document_root = build_directory.dirname
    path_info = build_directory.relative_to(document_root)
    Ro.normalize_url("http://localhost:#{port}/#{path_info}")
  end

  def watch(directory, &block)
    require 'ak47'

    def File.exists?(...) # monkey patch for Ak47 ;-/
      File.exist?(...)
    end

    Ak47(watch_dirs: directory) do
      block.call
    end
  end

  def watcher!
    Thread.new do
      Thread.current.abort_on_exception = true
      system "RO_URL=#{Ro.config.url} RO_ROOT=#{Ro.config.root} ro build --watch"
    end
  end

  def setup!
    root = @options[:root]
    Ro.root = root if root

    port = Ro.cast(:int, (@options[:port] || @options[:p] || ENV['PORT'] || Ro.config.port))
    opts.set(:port, port)

    watch = Ro.cast(:bool, @options[:watch] || @options[:w])
    opts.set(:watch, watch)
  end

  def opts
    @opts ||= Map.new
  end
end

BEGIN {
  $stdout.sync = true
  $stderr.sync = true

  $script = File.expand_path(__FILE__)
  $bindir = File.dirname($script)
  $root = File.dirname($bindir)
  $libdir = File.join($root, 'lib')

  Dir.chdir($root)

  require "#{$libdir}/ro"
  require "#{$libdir}/ro/script.rb"
}
